name: Build and Deploy to Lightsail

on:
  workflow_dispatch:
    inputs:
      deploy_message:
        description: 'Deployment message (optional)'
        required: false
        default: 'Manual deployment triggered'

jobs:
  # Job 1: Build Java Application
  build-java:
    name: "Build Java Application"
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Build with Maven
      run: |
        echo "=== Build Java Application Job Started ==="
        echo "Date: $(date)"
        echo "Working directory: $(pwd)"
        echo "Java version:"
        java -version
        echo ""
        echo "=== Starting Maven build ==="
        mvn clean package -DskipTests
        echo ""
        echo "=== Build completed successfully ==="
        echo "Generated JAR files:"
        ls -lh target/*.jar
      working-directory: backend
    
    - name: Upload JAR artifact
      uses: actions/upload-artifact@v4
      with:
        name: jar-artifact
        path: backend/target/*.jar

  # Job 2: Build and Push Docker Image
  build-docker:
    name: "Build Docker Image"
    needs: build-java
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Download JAR artifact
      uses: actions/download-artifact@v4
      with:
        name: jar-artifact
        path: backend/target/
    
    - name: Verify artifact
      run: |
        echo "=== Build Docker Image Job Started ==="
        echo "Date: $(date)"
        echo ""
        echo "=== Verifying JAR artifact ==="
        echo "Contents of backend/target:"
        ls -lh backend/target/
        echo ""
        if [ ! -f backend/target/*.jar ]; then
          echo "ERROR: JAR file not found!"
          exit 1
        fi
        echo "JAR artifact verified successfully"
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    - name: Login to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    
    - name: Build and push Docker image
      uses: docker/build-push-action@v4
      with:
        context: ./backend
        push: true
        tags: ${{ secrets.DOCKERHUB_USERNAME }}/nghood-backend:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max

  # Job 3: Deploy Frontend Files
  deploy-frontend:
    name: "Deploy Frontend Files"
    needs: build-docker
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Deploy frontend files
      uses: appleboy/scp-action@v0.1.5
      with:
        host: ${{ secrets.LIGHTSAIL_HOST }}
        username: ubuntu
        key: ${{ secrets.LIGHTSAIL_SSH_KEY }}
        source: "docs/*,nginx/nginx.conf,docker-compose.yml,infrastructure/renew-ssl.sh"
        target: "~/app/temp"
        rm: true
    
    - name: Move frontend files to correct location
      uses: appleboy/ssh-action@v1
      with:
        host: ${{ secrets.LIGHTSAIL_HOST }}
        username: ubuntu
        key: ${{ secrets.LIGHTSAIL_SSH_KEY }}
        script: |
          set -e
          echo "=== Moving frontend files ==="
          
          # Clear old frontend files
          rm -rf ~/app/frontend/*
          
          # Move new frontend files
          mv ~/app/temp/docs/* ~/app/frontend/
          
          # Move nginx config
          cp ~/app/temp/nginx/nginx.conf ~/app/nginx/nginx.conf

          # Move docker-compose.yml
          cp ~/app/temp/docker-compose.yml ~/app/docker-compose.yml
          
          # Setup renewal script
          cp ~/app/temp/infrastructure/renew-ssl.sh ~/app/renew-ssl.sh
          chmod +x ~/app/renew-ssl.sh
          
          # Clean up temp directory
          rm -rf ~/app/temp
          
          echo "Frontend files deployed successfully"

  # Job 4: Pre-deployment (Pull images and stop old containers)
  pre-deploy:
    name: "Pre-deployment"
    needs: [build-docker, deploy-frontend]
    runs-on: ubuntu-latest
    
    steps:
    - name: Pre-deployment tasks
      uses: appleboy/ssh-action@v1
      with:
        host: ${{ secrets.LIGHTSAIL_HOST }}
        username: ubuntu
        key: ${{ secrets.LIGHTSAIL_SSH_KEY }}
        script: |
          set -e
          echo "=== Pre-deployment Job Started ==="
          echo "Date: $(date)"
          echo "Server: $(hostname)"
          echo ""
          
          echo "=== System information ==="
          echo "Docker version: $(docker --version)"
          echo "Docker-compose version: $(docker-compose --version)"
          echo ""
          
          echo "=== Navigating to app directory ==="
          cd ~/app
          echo "Current directory: $(pwd)"
          echo ""
          
          echo "=== Current running containers ==="
          docker-compose ps
          echo ""
          
          echo "=== Pulling latest Docker images ==="
          docker-compose pull
          echo ""
          
          echo "=== Stopping old containers ==="
          docker-compose down
          echo "Old containers stopped and removed"

  # Job 5: Deploy (Start new containers)
  deploy:
    name: "Deploy Application"
    needs: pre-deploy
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy application
      uses: appleboy/ssh-action@v1
      with:
        host: ${{ secrets.LIGHTSAIL_HOST }}
        username: ubuntu
        key: ${{ secrets.LIGHTSAIL_SSH_KEY }}
        script: |
          set -e
          echo "=== Deploy Application Job Started ==="
          echo "Date: $(date)"
          echo ""
          
          echo "=== Navigating to app directory ==="
          cd ~/app
          
          echo "=== Starting new containers ==="
          export NGINX_CONFIG_FILE=nginx.conf
          export FRONTEND_PATH=./frontend
          export DOCKER_IMAGE=${{ secrets.DOCKERHUB_USERNAME }}/nghood-backend:latest
          
          # Copy fresh SSL certificates from host to app directory
          echo "=== Refreshing SSL certificates ==="
          mkdir -p ~/app/nginx/ssl
          sudo cp -L /etc/letsencrypt/live/christianity.nghood.com/fullchain.pem ~/app/nginx/ssl/
          sudo cp -L /etc/letsencrypt/live/christianity.nghood.com/privkey.pem ~/app/nginx/ssl/
          
          # Ensure docker can read them
          sudo chmod 644 ~/app/nginx/ssl/fullchain.pem
          sudo chmod 644 ~/app/nginx/ssl/privkey.pem
          
          docker-compose up -d
          echo ""
          
          echo "=== Waiting for application startup (15 seconds) ==="
          sleep 15
          echo "Startup wait completed"

  # Job 6: Verify deployment
  verify:
    name: "Verify Deployment"
    needs: deploy
    runs-on: ubuntu-latest
    
    steps:
    - name: Verify deployment health
      uses: appleboy/ssh-action@v1
      with:
        host: ${{ secrets.LIGHTSAIL_HOST }}
        username: ubuntu
        key: ${{ secrets.LIGHTSAIL_SSH_KEY }}
        script: |
          set -e
          echo "=== Verify Deployment Job Started ==="
          echo "Date: $(date)"
          echo ""
          
          echo "=== Checking container status ==="
          cd ~/app
          docker-compose ps
          echo ""
          
          echo "=== Checking application logs (last 20 lines) ==="
          docker-compose logs --tail=20 spring-backend
          echo ""
          
          echo "=== Performing backend health check ==="
          if curl -f -k https://localhost/actuator/health; then
            echo ""
            echo "✅ Backend health check passed!"
          else
            echo ""
            echo "❌ Backend health check failed!"
            echo ""
            echo "=== Showing detailed logs for debugging ==="
            docker-compose logs --tail=50
            exit 1
          fi
          
          echo ""
          echo "=== Checking frontend accessibility ==="
          if curl -f -s -k https://localhost/ | grep -q "nghood Christianity"; then
            echo "✅ Frontend is accessible!"
          else
            echo "❌ Frontend is not accessible!"
            exit 1
          fi
          
          echo ""
          echo "=== Deployment completed successfully! ==="
          echo "Application is healthy and running"
          echo "Frontend URL: https://christianity.nghood.com"
          echo "Deployment finished at: $(date)"